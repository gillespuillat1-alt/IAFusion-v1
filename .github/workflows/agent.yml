name: IAFUSION Agent
on:
  issue_comment:
    types: [created]

permissions:
  contents: write

jobs:
  apply:
    if: startsWith(github.event.comment.body, '/agent files')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: principal

      - name: Parse blocks and write files
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body;
            const blocks = [...body.matchAll(/```path=([^\n]+)\n([\s\S]*?)```/g)];
            if (blocks.length === 0) { core.setFailed('No `path=` blocks found'); return; }
            const fs = require('fs'); const path = require('path');
            for (const [,p,content] of blocks) {
              const full = path.join(process.env.GITHUB_WORKSPACE, p.trim());
              fs.mkdirSync(path.dirname(full), { recursive:true });
              fs.writeFileSync(full, content.trim() + '\n', 'utf8');
              core.info('Wrote ' + p);
            }

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "agent: apply files from comment" || echo "Nothing to commit"
          git push
