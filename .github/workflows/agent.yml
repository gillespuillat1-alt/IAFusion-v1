name: Agent IAFUSION
on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  agent:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.comment.body, '/agent files')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: principal
          fetch-depth: 0

      - name: Apply files from comment
        shell: python
        run: |
          import os, re, json, pathlib, sys
          ev = json.load(open(os.environ["GITHUB_EVENT_PATH"]))
          text = ev.get("comment", {}).get("body", "") if ev.get("comment") else ev.get("inputs", {}).get("files", "")
          blocks = re.findall(r"```path=(.*?)\n(.*?)```", text, flags=re.S)
          if not blocks:
            print("No file blocks found."); sys.exit(1)
          for rel, content in blocks:
            p = pathlib.Path(rel.strip())
            p.parent.mkdir(parents=True, exist_ok=True)
            p.write_text(content, encoding="utf-8")
            print("Wrote", p)

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "agent: apply files from comment"
